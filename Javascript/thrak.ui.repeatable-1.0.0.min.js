(function($){$.widget('thrak.repeatable',{options:{minInstances:1,maxInstances:4},data:{currentId:0,template:null,buttonsetTemplate:null,repeatableButtonset:null,defaultButtonsetTemplate:'<div class="repeatable-buttonset repeatable-buttonset-default" target="#target">'+'	<div class="repeatable-button repeatable-button-minus" title="#delete"></div>'+'	<div class="repeatable-button repeatable-button-plus" title="#add"></div>'+'</div>',defaultButtonsetPosition:'last'},messages:{'fr':{addButtonTooltip:"Ajoute un &eacute;l&eacute;ment",deleteButtonTooltip:"Supprime cet &eacute;l&eacute;ment"},'en':{addButtonTooltip:"Add an item",deleteButtonTooltip:"Remove this item"}},_create:function(){var $this=this.element;var $parent=$this.parent();var this_id=$this.attr('id');this.options.data=$.extend({},this.data);var min_instances=parseInt($this.attr('min-instances'));max_instances=parseInt($this.attr('max-instances'));if(!isNaN(min_instances))
this.options.minInstances=min_instances;if(!isNaN(max_instances))
this.options.maxInstances=max_instances;if(this.options.minInstances<1)
this.options.minInstances=1;if(this.options.maxInstances<this.options.minInstances)
this.options.maxInstances=this.options.maxInstances;$this.removeAttr('min-instances').removeAttr('max-instances');var $buttonset=$('.repeatable-buttonset[target="'+this_id+'"]');var $buttonset_parent=$buttonset.parent('.repeatable');var is_inside=1;if($buttonset.length==0){var lang=($.locale)? $.locale():'en';var template=this.options.data.defaultButtonsetTemplate.replace(/#target/,this_id).replace(/#add/,this.messages[lang].addButtonTooltip).replace(/#delete/,this.messages[lang].deleteButtonTooltip);if(this.options.data.defaultButtonsetPosition=='last'){$this.append(template);$('.repeatable-buttonset',$this).addClass('repeatable-buttonset-last');}
else{$this.prepend(template);$('.repeatable-buttonset',$this).addClass('repeatable-buttonset-first');}
this.options.data.buttonsetTemplate=template;}
else{if($buttonset_parent.length==0)
is_inside=0;this.options.data.buttonsetTemplate=$buttonset.outerHtml();this.options.data.repeatableButtonset=is_inside;}
this.options.data.template=$this.outerHtml();$this.html('');this._create_initial_instances();},_create_initial_instances:function(){var $this=this.element;var instances=$('.repeatable-instance',$this.parent());var length=instances.length;this.options.data.currentId=length;for(var i=length;i<this.options.minInstances;i++)
this._append_from_template();this._update_buttonset();},_append_from_template:function(){var $widget=this;var $this=this.element;var $parent=$this.parent();var instances=$('.repeatable-instance',$this.parent());var length=instances.length;if(length==this.options.maxInstances)
return;var instance=$parent.append(this.options.data.template).children().last();this.options.data.currentId++;instance.addClass('repeatable-instance');$('.repeatable-button-plus',instance).click(function(e){var $this=$(this);if($this.hasClass('repeatable-button-disabled')){e&&e.preventDefault&&e.preventDefault();e&&e.stopPropagation&&e.stopPropagation();e&&e.stopImmediatePropagation&&e.stopImmediatePropagation();return(false);}
$widget._add_instance.apply($widget);});$('.repeatable-button-minus',instance).click(function(e){var $this=$(this);if($this.hasClass('repeatable-button-disabled')){e&&e.preventDefault&&e.preventDefault();e&&e.stopPropagation&&e.stopPropagation();e&&e.stopImmediatePropagation&&e.stopImmediatePropagation();return(false);}
$widget._delete_instance.apply($widget,[instance])});$('[id]:not([data-index])',instance).each(function(index,item){var $this=$(item);var id=$this.attr('id');var name=$this.attr('name');var newid=id+"_"+$widget.options.data.currentId;$this.attr('id',newid);$this.attr('data-index',$widget.options.data.currentId);if(name===undefined||name==id)
$this.attr('name',newid);});},_update_buttonset:function(){var instances=$('.repeatable-instance',this.element.parent());var min=this.options.minInstances,max=this.options.maxInstances;if(min==max){$('.repeatable-button-minus, .repeateable-button-minus').addClass('repeatable-button-none');return;}
var length=instances.length;if(length==min){$('.repeatable-button-minus',instances).addClass('repeatable-button-disabled');$('.repeatable-button-plus',instances).removeClass('repeatable-button-disabled');}
else if(length==max){$('.repeatable-button-minus',instances).removeClass('repeatable-button-disabled');$('.repeatable-button-plus',instances).addClass('repeatable-button-disabled');}
else{$('.repeatable-button-minus',instances).removeClass('repeatable-button-disabled');$('.repeatable-button-plus',instances).removeClass('repeatable-button-disabled');}},_add_instance:function(){this._append_from_template();this._update_buttonset();},_delete_instance:function(instance){instance.remove();this._create_initial_instances();},_delete_all_instances:function($widget){$('.repeatable-instance',$widget.element).remove();$widget._create_initial_instances();},});}(jQuery));